<div class="header">
  <h1 class="page-title">Liste des demandes d'articles</h1>

  <button
    class="button black-button"
    (click)="setModals({ showExportModal: true })"
  >
    Exporter demandes
  </button>
</div>

<div class="card">
  <div class="card-header">
    <div class="card-title">{{ demandes.length }} Demandes affichées</div>
    <div class="card-search">
      <form [formGroup]="searchForm" (submit)="onSearch()" style="width: 100%">
        <input
          type="text"
          placeholder="Cherchez demandes par code"
          class="search-bar"
          formControlName="nom"
        />
      </form>
      <button
        class="filter-button"
        (click)="setModals({ showFilterModal: true })"
      >
        <i class="fa-solid fa-filter"></i>
      </button>
    </div>
  </div>

  <app-error *ngIf="error.show" [message]="error.message"></app-error>
  <app-alert
    *ngIf="alert.show"
    [message]="alert.message"
    (restore)="onRestore()"
  ></app-alert>

  <div class="table-container" style="margin-top: 20px">
    <table class="data-table">
      <thead>
        <tr>
          <th id="first-col">Code</th>
          <th>Articles</th>
          <th>Chantier</th>
          <th>Date</th>
          <th>Observation</th>
          <th id="last-col">Statut</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let demande of demandes" style="cursor: pointer">
          <td (click)="onSelectDemande(demande)">{{ demande.id }}</td>
          <td (click)="onShowArticles(demande)">
            <button class="button black-button">
              Voir articles ({{ demande.items.length }})
            </button>
          </td>
          <td (click)="onSelectDemande(demande)">
            {{ demande.chantier.nom }}
          </td>
          <td (click)="onSelectDemande(demande)">
            {{ demande.date | date: "dd/MM/yyyy" }}
          </td>
          <td (click)="onSelectDemande(demande)">
            {{ demande.observation || "---" }}
          </td>
          <td (click)="onSelectDemande(demande)">
            <span
              [ngClass]="{
                'status-badge': true,
                'status-pending': demande.status === 'pending',
                'status-confirmed': demande.status === 'confirmed',
                'status-denied': demande.status === 'denied',
              }"
            >
              {{ demande.status == "confirmed" ? "Confirmé" : "En Attente" }}
            </span>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<br />

<div
  *ngIf="!pagination.lastPage && !error.show && !loading"
  style="display: flex; justify-content: center"
>
  <button class="button gray-button" (click)="loadMore()">Afficher Plus</button>
</div>

<div *ngIf="modalSettings.showArticlesListModal">
  <app-articles-list-modal
    [articles]="selectedArticles"
    (close)="setModals({ showArticlesListModal: false })"
  ></app-articles-list-modal>
</div>

<div *ngIf="modalSettings.showDetailsModal">
  <app-demande-details-modal
    [demande]="selectedDemande"
    (close)="setModals({ showDetailsModal: false })"
    (confirm)="onConfirmDemande()"
    (delete)="onDeleteDemande()"
  ></app-demande-details-modal>
</div>

<div *ngIf="modalSettings.showFilterModal">
  <app-filter-demandes-modal
    (close)="setModals({ showFilterModal: false })"
    (filter)="onFilter($event)"
  ></app-filter-demandes-modal>
</div>

<app-loading *ngIf="loading"></app-loading>

<app-export-modal
  *ngIf="modalSettings.showExportModal"
  [resource]="'demandes'"
  (close)="setModals({ showExportModal: false })"
  (export)="onExport($event)"
></app-export-modal>
