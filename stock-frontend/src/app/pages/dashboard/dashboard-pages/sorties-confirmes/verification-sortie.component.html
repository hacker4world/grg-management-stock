<div class="header">
  <h1 class="page-title">Liste des sorties confirmées</h1>
  <div class="user-menu">
    <button
      (click)="setModals({ showExportModal: true })"
      class="button black-button"
    >
      Exporter sorties
    </button>
  </div>
</div>

<div class="card">
  <div class="card-header">
    <div class="card-title">
      {{ sorties.length }}
      {{ sorties.length === 1 ? "Sortie affichée" : "Sorties affichées" }}
    </div>
    <div class="card-search">
      <form [formGroup]="searchForm" (submit)="onSearch()" style="width: 100%">
        <input
          type="text"
          placeholder="Cherchez une sortie par code"
          class="search-bar"
          formControlName="code"
        />
      </form>
      <button
        class="filter-button"
        (click)="setModals({ showFilterModal: true })"
      >
        <i class="fa-solid fa-filter"></i>
      </button>
    </div>
  </div>

  <!-- Error Handling -->
  <app-error *ngIf="error.show" [message]="error.message"></app-error>

  <!-- 2. Add the Alert component for active filters -->
  <app-alert
    *ngIf="alert.show"
    [message]="alert.message"
    (restore)="onRestore()"
  ></app-alert>

  <div class="table-container" style="margin-top: 20px">
    <table class="data-table">
      <thead>
        <tr>
          <th id="first-col">Code</th>
          <th>Articles</th>
          <th>Date</th>
          <th>Type</th>
          <th id="last-col">Magazinier</th>
        </tr>
      </thead>
      <tbody>
        <tr
          (click)="onSelectSortie(s)"
          *ngFor="let s of sorties"
          style="cursor: pointer"
        >
          <td>{{ s.id }}</td>
          <td>
            <button
              class="button black-button"
              (click)="onViewArticles($event, s)"
            >
              Voir articles
            </button>
          </td>
          <td>{{ s.date | date: "dd/MM/yyyy" }}</td>
          <td>{{ getTypeSortieLabel(s.typeSortie) }}</td>
          <td>{{ s.compte.nom + " " + s.compte.prenom }}</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Loading spinner -->
  <div
    *ngIf="loading"
    class="loading-container"
    style="display: flex; justify-content: center; padding: 20px"
  >
    <div class="spinner"></div>
    <span style="margin-left: 10px">Chargement des sorties...</span>
  </div>
</div>

<br />

<!-- Pagination Pattern -->
<div
  *ngIf="!pagination.lastPage && !error.show && !loading"
  style="display: flex; justify-content: center"
>
  <button class="button gray-button" (click)="loadMore()">Afficher Plus</button>
</div>

<app-sortie-confirme-details-modal
  *ngIf="modalSettings.showDetailsModal && selectedSortie"
  [sortie]="selectedSortie"
  (close)="setModals({ showDetailsModal: false })"
  (delete)="onDeleteSuccess()"
></app-sortie-confirme-details-modal>

<app-sortie-articles
  *ngIf="modalSettings.showArticlesModal && selectedSortie"
  [articleList]="selectedSortie.articleSorties"
  (close)="setModals({ showArticlesModal: false })"
></app-sortie-articles>

<app-export-modal
  *ngIf="modalSettings.showExportModal"
  resource="sorties confirmées"
  (close)="setModals({ showExportModal: false })"
  (export)="onExport($event)"
></app-export-modal>

<app-filter-sortie-en-attente-modal
  *ngIf="modalSettings.showFilterModal"
  (close)="setModals({ showFilterModal: false })"
  (filter)="onFilter($event)"
></app-filter-sortie-en-attente-modal>
