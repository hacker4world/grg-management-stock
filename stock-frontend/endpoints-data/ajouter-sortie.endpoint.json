{
  "endpoint": {
    "method": "POST",
    "path": "/api/sorties/create",
    "description": "Create a new sortie (stock exit) with type-specific validation and field handling",
    "baseUrl": "http://localhost:4000/api"
  },
  "input": {
    "description": "Request body for creating a sortie. The schema varies based on typeSortie",
    "contentType": "application/json",
    "commonFields": {
      "compteId": {
        "type": "number",
        "required": true,
        "description": "ID of the account creating the sortie. Must be ADMIN, ADMIN1, or MAGAZINIER role"
      },
      "typeSortie": {
        "type": "string",
        "required": true,
        "enum": ["interne_depot", "interne_chantier", "externe"],
        "description": "Type of sortie determining which fields are required"
      },
      "articles": {
        "type": "array",
        "required": true,
        "description": "List of articles being removed from stock",
        "items": {
          "type": "object",
          "properties": {
            "articleId": {
              "type": "number",
              "required": true,
              "description": "ID of the article"
            },
            "stockSortie": {
              "type": "number",
              "required": true,
              "description": "Quantity of article to remove from stock"
            }
          }
        }
      },
      "observation": {
        "type": "string",
        "required": false,
        "nullable": true,
        "description": "Optional observation or notes about the sortie"
      }
    },
    "variants": {
      "interne_depot": {
        "description": "Internal sortie to a depot",
        "additionalFields": {
          "depotId": {
            "type": "number",
            "required": true,
            "description": "ID of the destination depot"
          },
          "nomTransporteur": {
            "type": "string",
            "required": true,
            "description": "Name of the transporter"
          },
          "matriculeTransporteur": {
            "type": "string",
            "required": true,
            "description": "Registration/license plate of the transporter vehicle"
          }
        }
      },
      "interne_chantier": {
        "description": "Internal sortie to a construction site (chantier)",
        "additionalFields": {
          "chantierId": {
            "type": "number",
            "required": true,
            "description": "Code of the destination chantier"
          },
          "nomTransporteur": {
            "type": "string",
            "required": true,
            "description": "Name of the transporter"
          },
          "matriculeTransporteur": {
            "type": "string",
            "required": true,
            "description": "Registration/license plate of the transporter vehicle"
          }
        }
      },
      "externe": {
        "description": "External sortie to a company/client",
        "additionalFields": {
          "sousTypeSortieExterne": {
            "type": "string",
            "required": true,
            "enum": ["avec_transporteur", "sans_transporteur"],
            "description": "Whether the external sortie includes a transporter"
          },
          "nomEntreprise": {
            "type": "string",
            "required": true,
            "description": "Name of the destination company"
          },
          "adresseEntreprise": {
            "type": "string",
            "required": true,
            "description": "Address of the destination company"
          },
          "matriculeFiscalEntreprise": {
            "type": "string",
            "required": true,
            "description": "Tax ID/fiscal number of the company"
          },
          "nomClient": {
            "type": "string",
            "required": true,
            "description": "Name of the client"
          },
          "nomTransporteur": {
            "type": "string",
            "required": true,
            "conditionalOn": "sousTypeSortieExterne === 'avec_transporteur'",
            "description": "Name of the transporter (only if avec_transporteur)"
          },
          "matriculeTransporteur": {
            "type": "string",
            "required": true,
            "conditionalOn": "sousTypeSortieExterne === 'avec_transporteur'",
            "description": "Registration/license plate of transporter (only if avec_transporteur)"
          }
        }
      }
    },
    "examples": {
      "interne_depot_example": {
        "compteId": 1,
        "typeSortie": "interne_depot",
        "depotId": 5,
        "nomTransporteur": "Transport ABC",
        "matriculeTransporteur": "ABC-123-XYZ",
        "observation": "Urgent delivery",
        "articles": [
          {
            "articleId": 10,
            "stockSortie": 50
          },
          {
            "articleId": 15,
            "stockSortie": 25
          }
        ]
      },
      "interne_chantier_example": {
        "compteId": 2,
        "typeSortie": "interne_chantier",
        "chantierId": 3,
        "nomTransporteur": "Transport XYZ",
        "matriculeTransporteur": "XYZ-456-DEF",
        "observation": null,
        "articles": [
          {
            "articleId": 20,
            "stockSortie": 100
          }
        ]
      },
      "externe_avec_transporteur_example": {
        "compteId": 1,
        "typeSortie": "externe",
        "sousTypeSortieExterne": "avec_transporteur",
        "nomEntreprise": "Construction Ltd",
        "adresseEntreprise": "123 Main Street, City",
        "matriculeFiscalEntreprise": "FR12345678901",
        "nomClient": "John Doe",
        "nomTransporteur": "Express Delivery",
        "matriculeTransporteur": "EXP-789-GHI",
        "observation": "Handle with care",
        "articles": [
          {
            "articleId": 30,
            "stockSortie": 75
          }
        ]
      },
      "externe_sans_transporteur_example": {
        "compteId": 3,
        "typeSortie": "externe",
        "sousTypeSortieExterne": "sans_transporteur",
        "nomEntreprise": "Retail Store",
        "adresseEntreprise": "456 Oak Avenue, Town",
        "matriculeFiscalEntreprise": "FR98765432109",
        "nomClient": "Jane Smith",
        "observation": null,
        "articles": [
          {
            "articleId": 40,
            "stockSortie": 200
          },
          {
            "articleId": 45,
            "stockSortie": 150
          }
        ]
      }
    }
  },
  "output": {
    "description": "Response from the create sortie endpoint",
    "contentType": "application/json",
    "successResponse": {
      "statusCode": 201,
      "schema": {
        "message": {
          "type": "string",
          "value": "Sortie créée",
          "description": "Success message"
        },
        "sortie": {
          "type": "object",
          "description": "The created sortie object with all relations loaded",
          "properties": {
            "id": {
              "type": "number",
              "description": "Unique identifier of the sortie"
            },
            "date": {
              "type": "string",
              "format": "YYYY-MM-DD",
              "description": "Date the sortie was created (current date)"
            },
            "typeSortie": {
              "type": "string",
              "enum": ["interne_depot", "interne_chantier", "externe"],
              "description": "Type of sortie"
            },
            "status": {
              "type": "string",
              "value": "pending",
              "description": "Status of the sortie (always 'pending' on creation)"
            },
            "observation": {
              "type": "string",
              "nullable": true,
              "description": "Optional observation notes"
            },
            "compte": {
              "type": "object",
              "description": "Account that created the sortie",
              "properties": {
                "id": {
                  "type": "number"
                },
                "role": {
                  "type": "string",
                  "enum": ["ADMIN", "ADMIN1", "MAGAZINIER"]
                }
              }
            },
            "depot": {
              "type": "object",
              "nullable": true,
              "description": "Destination depot (only for interne_depot type)",
              "properties": {
                "id": {
                  "type": "number"
                },
                "nom": {
                  "type": "string"
                }
              }
            },
            "chantier": {
              "type": "object",
              "nullable": true,
              "description": "Destination chantier (only for interne_chantier type)",
              "properties": {
                "code": {
                  "type": "number"
                },
                "nom": {
                  "type": "string"
                }
              }
            },
            "nomTransporteurDepot": {
              "type": "string",
              "nullable": true,
              "description": "Transporter name for depot sortie"
            },
            "matriculeTransporteurDepot": {
              "type": "string",
              "nullable": true,
              "description": "Transporter registration for depot sortie"
            },
            "nomTransporteurChantier": {
              "type": "string",
              "nullable": true,
              "description": "Transporter name for chantier sortie"
            },
            "matriculeTransporteurChantier": {
              "type": "string",
              "nullable": true,
              "description": "Transporter registration for chantier sortie"
            },
            "sousTypeSortieExterne": {
              "type": "string",
              "nullable": true,
              "enum": ["avec_transporteur", "sans_transporteur"],
              "description": "Sub-type for external sorties"
            },
            "nomEntreprise": {
              "type": "string",
              "nullable": true,
              "description": "Company name for external sortie"
            },
            "adresseEntreprise": {
              "type": "string",
              "nullable": true,
              "description": "Company address for external sortie"
            },
            "matriculeFiscalEntreprise": {
              "type": "string",
              "nullable": true,
              "description": "Company tax ID for external sortie"
            },
            "nomClient": {
              "type": "string",
              "nullable": true,
              "description": "Client name for external sortie"
            },
            "nomTransporteurExterne": {
              "type": "string",
              "nullable": true,
              "description": "Transporter name for external sortie (if avec_transporteur)"
            },
            "matriculeTransporteurExterne": {
              "type": "string",
              "nullable": true,
              "description": "Transporter registration for external sortie (if avec_transporteur)"
            },
            "articleSorties": {
              "type": "array",
              "description": "Array of article lines in this sortie",
              "items": {
                "type": "object",
                "properties": {
                  "id": {
                    "type": "number"
                  },
                  "stockSortie": {
                    "type": "number",
                    "description": "Quantity of article in this sortie"
                  },
                  "article": {
                    "type": "object",
                    "properties": {
                      "id": {
                        "type": "number"
                      },
                      "nom": {
                        "type": "string"
                      },
                      "stockActuel": {
                        "type": "number"
                      }
                    }
                  }
                }
              }
            }
          }
        }
      },
      "example": {
        "message": "Sortie créée",
        "sortie": {
          "id": 42,
          "date": "2024-01-15",
          "typeSortie": "interne_depot",
          "status": "pending",
          "observation": "Urgent delivery",
          "compte": {
            "id": 1,
            "role": "ADMIN"
          },
          "depot": {
            "id": 5,
            "nom": "Depot Central"
          },
          "chantier": null,
          "nomTransporteurDepot": "Transport ABC",
          "matriculeTransporteurDepot": "ABC-123-XYZ",
          "nomTransporteurChantier": null,
          "matriculeTransporteurChantier": null,
          "sousTypeSortieExterne": null,
          "nomEntreprise": null,
          "adresseEntreprise": null,
          "matriculeFiscalEntreprise": null,
          "nomClient": null,
          "nomTransporteurExterne": null,
          "matriculeTransporteurExterne": null,
          "articleSorties": [
            {
              "id": 101,
              "stockSortie": 50,
              "article": {
                "id": 10,
                "nom": "Cement Bag",
                "stockActuel": 450
              }
            },
            {
              "id": 102,
              "stockSortie": 25,
              "article": {
                "id": 15,
                "nom": "Steel Rod",
                "stockActuel": 975
              }
            }
          ]
        }
      }
    },
    "errorResponses": [
      {
        "statusCode": 400,
        "scenario": "Invalid compte ID",
        "schema": {
          "message": {
            "type": "string",
            "value": "Compte introuvable"
          }
        }
      },
      {
        "statusCode": 400,
        "scenario": "Compte does not have required role",
        "schema": {
          "message": {
            "type": "string",
            "value": "Le compte doit être un admin ou un magazinier"
          }
        }
      },
      {
        "statusCode": 404,
        "scenario": "Article not found",
        "schema": {
          "message": {
            "type": "string",
            "value": "Article {articleId} inconnu"
          }
        }
      },
      {
        "statusCode": 404,
        "scenario": "Depot not found (for interne_depot)",
        "schema": {
          "message": {
            "type": "string",
            "value": "Dépôt introuvable"
          }
        }
      },
      {
        "statusCode": 404,
        "scenario": "Chantier not found (for interne_chantier)",
        "schema": {
          "message": {
            "type": "string",
            "value": "Chantier introuvable"
          }
        }
      },
      {
        "statusCode": 400,
        "scenario": "Invalid sortie type",
        "schema": {
          "message": {
            "type": "string",
            "value": "Type de sortie invalide"
          }
        }
      },
      {
        "statusCode": 500,
        "scenario": "Server error",
        "schema": {
          "message": {
            "type": "string",
            "value": "Erreur lors de la création de la sortie"
          },
          "detail": {
            "type": "string",
            "description": "Error message details"
          }
        }
      }
    ]
  },
  "validationRules": {
    "compteId": {
      "required": true,
      "type": "number",
      "mustExist": true,
      "mustHaveRole": ["ADMIN", "ADMIN1", "MAGAZINIER"]
    },
    "typeSortie": {
      "required": true,
      "type": "string",
      "allowedValues": ["interne_depot", "interne_chantier", "externe"]
    },
    "articles": {
      "required": true,
      "type": "array",
      "minItems": 1,
      "items": {
        "articleId": {
          "required": true,
          "type": "number",
          "mustExist": true
        },
        "stockSortie": {
          "required": true,
          "type": "number",
          "minValue": 1
        }
      }
    },
    "observation": {
      "required": false,
      "type": "string",
      "nullable": true
    },
    "depotId": {
      "required": true,
      "conditionalOn": "typeSortie === 'interne_depot'",
      "type": "number",
      "mustExist": true
    },
    "chantierId": {
      "required": true,
      "conditionalOn": "typeSortie === 'interne_chantier'",
      "type": "number",
      "mustExist": true
    },
    "nomTransporteur": {
      "required": true,
      "conditionalOn": "typeSortie !== 'externe' OR sousTypeSortieExterne === 'avec_transporteur'",
      "type": "string"
    },
    "matriculeTransporteur": {
      "required": true,
      "conditionalOn": "typeSortie !== 'externe' OR sousTypeSortieExterne === 'avec_transporteur'",
      "type": "string"
    },
    "sousTypeSortieExterne": {
      "required": true,
      "conditionalOn": "typeSortie === 'externe'",
      "type": "string",
      "allowedValues": ["avec_transporteur", "sans_transporteur"]
    },
    "nomEntreprise": {
      "required": true,
      "conditionalOn": "typeSortie === 'externe'",
      "type": "string"
    },
    "adresseEntreprise": {
      "required": true,
      "conditionalOn": "typeSortie === 'externe'",
      "type": "string"
    },
    "matriculeFiscalEntreprise": {
      "required": true,
      "conditionalOn": "typeSortie === 'externe'",
      "type": "string"
    },
    "nomClient": {
      "required": true,
      "conditionalOn": "typeSortie === 'externe'",
      "type": "string"
    }
  },
  "notes": {
    "dateHandling": "The date is automatically set to the current date (YYYY-MM-DD format) on creation",
    "statusHandling": "All newly created sorties have status 'pending' and must be confirmed or denied via the confirm-deny endpoint",
    "typeSpecificFields": "Null fields are set based on sortie type to maintain data integrity",
    "articleValidation": "All articles must exist in the database before sortie creation",
    "relationsLoaded": "The response includes all related entities (compte, depot, chantier, articleSorties with article details)",
    "transactionHandling": "Sortie and article lines are created in sequence; if any step fails, the entire operation may be partially completed"
  }
}
